# ===================================================
# BeZhas Web3 - CI/CD Pipeline for Google Cloud
# ===================================================
# This workflow handles:
# - Testing (Solidity, Backend, Frontend)
# - Building Docker images
# - Deploying to Cloud Run
# - Security scanning
# ===================================================

name: CI/CD Pipeline - GCP

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".vscode/**"
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: us-central1
  REGION: us-central1
  BACKEND_SERVICE: bezhas-backend
  FRONTEND_SERVICE: bezhas-frontend
  NODE_VERSION: "20"

jobs:
  # ===================================================
  # JOB 1: Lint and Security Scan
  # ===================================================
  lint-and-security:
    name: Lint & Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install root dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Lint frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run lint
        continue-on-error: false

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  # ===================================================
  # JOB 2: Smart Contract Tests
  # ===================================================
  test-contracts:
    name: Solidity Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npx hardhat compile

      - name: Run Hardhat tests
        run: npx hardhat test
        env:
          REPORT_GAS: true

      - name: Generate coverage report
        run: npx hardhat coverage
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: contracts
          name: solidity-coverage
        continue-on-error: true

  # ===================================================
  # JOB 3: Backend Tests
  # ===================================================
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run backend tests
        working-directory: ./backend
        run: npm test -- --coverage --forceExit
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/bezhas_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_key_for_ci

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
        continue-on-error: true

  # ===================================================
  # JOB 4: Frontend Build & Test
  # ===================================================
  test-frontend:
    name: Frontend Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: https://api.bezhas.com
          VITE_CHAIN_ID: "137"
          VITE_NETWORK: polygon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  # ===================================================
  # JOB 5: Build & Push Docker Images
  # ===================================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint-and-security, test-contracts, test-backend, test-frontend]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    permissions:
      contents: read
      id-token: write

    outputs:
      backend_image: ${{ steps.build-backend.outputs.image }}
      frontend_image: ${{ steps.build-frontend.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build and push backend image
        id: build-backend
        run: |
          IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/bezhas/${{ env.BACKEND_SERVICE }}:${{ github.sha }}"
          docker build -t $IMAGE -f backend/Dockerfile.optimized backend/
          docker push $IMAGE
          docker tag $IMAGE ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/bezhas/${{ env.BACKEND_SERVICE }}:latest
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/bezhas/${{ env.BACKEND_SERVICE }}:latest
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        id: build-frontend
        run: |
          IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/bezhas/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}"
          docker build -t $IMAGE -f frontend/Dockerfile.optimized frontend/ \
            --build-arg VITE_API_URL=https://api.bezhas.com \
            --build-arg VITE_WS_URL=wss://api.bezhas.com \
            --build-arg VITE_CHAIN_ID=137 \
            --build-arg VITE_NETWORK=polygon
          docker push $IMAGE
          docker tag $IMAGE ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/bezhas/${{ env.FRONTEND_SERVICE }}:latest
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/bezhas/${{ env.FRONTEND_SERVICE }}:latest
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

  # ===================================================
  # JOB 6: Deploy to Staging
  # ===================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.bezhas.com

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy Backend to Cloud Run (Staging)
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}-staging
          region: ${{ env.REGION }}
          image: ${{ needs.build-images.outputs.backend_image }}
          flags: |
            --allow-unauthenticated
            --min-instances=0
            --max-instances=5
            --memory=512Mi
            --cpu=1
            --set-env-vars=NODE_ENV=staging
            --set-secrets=STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest

      - name: Deploy Frontend to Cloud Run (Staging)
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}-staging
          region: ${{ env.REGION }}
          image: ${{ needs.build-images.outputs.frontend_image }}
          flags: |
            --allow-unauthenticated
            --min-instances=0
            --max-instances=3

  # ===================================================
  # JOB 7: Deploy to Production
  # ===================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment:
      name: production
      url: https://bezhas.com

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy Backend to Cloud Run (Production)
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ needs.build-images.outputs.backend_image }}
          flags: |
            --allow-unauthenticated
            --min-instances=1
            --max-instances=100
            --memory=1Gi
            --cpu=2
            --concurrency=80
            --set-env-vars=NODE_ENV=production
            --set-secrets=MONGODB_URI=mongodb-uri:latest,REDIS_URL=redis-url:latest,JWT_SECRET=jwt-secret:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest

      - name: Deploy Frontend to Cloud Run (Production)
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ needs.build-images.outputs.frontend_image }}
          flags: |
            --allow-unauthenticated
            --min-instances=1
            --max-instances=50

      - name: Notify deployment success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "✅ BeZhas Production Deployment Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*✅ Production Deployment Complete*\n\n• Backend: `${{ env.BACKEND_SERVICE }}`\n• Frontend: `${{ env.FRONTEND_SERVICE }}`\n• Commit: `${{ github.sha }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  # ===================================================
  # JOB 8: Post-Deployment Verification
  # ===================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: success()

    steps:
      - name: Health check - Backend
        run: |
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://api.bezhas.com/api/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "✅ Backend health check passed"
              exit 0
            fi
            echo "Attempt $i: Backend returned $response, retrying..."
            sleep 10
          done
          echo "❌ Backend health check failed"
          exit 1

      - name: Health check - Frontend
        run: |
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://bezhas.com || echo "000")
            if [ "$response" = "200" ]; then
              echo "✅ Frontend health check passed"
              exit 0
            fi
            echo "Attempt $i: Frontend returned $response, retrying..."
            sleep 10
          done
          echo "❌ Frontend health check failed"
          exit 1
