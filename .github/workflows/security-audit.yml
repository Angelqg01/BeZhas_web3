name: Security Audit & Vulnerability Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security audit every day at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

# Cancel previous runs when new commits are pushed
concurrency:
  group: security-audit-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  security-events: write
  issues: write

env:
  NODE_VERSION: "20"

jobs:
  # ==========================================
  # 1. NPM AUDIT - Frontend & Backend
  # ==========================================
  npm-security-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Continue other jobs even if one fails
      matrix:
        workspace: [frontend, backend]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Don't use cache here - we'll cache manually to avoid path issues

      - name: Cache npm dependencies
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ~/.npm
          key: npm-${{ matrix.workspace }}-${{ hashFiles(format('{0}/package-lock.json', matrix.workspace)) }}
          restore-keys: |
            npm-${{ matrix.workspace }}-

      - name: Install Dependencies
        working-directory: ./${{ matrix.workspace }}
        run: npm ci --audit=false

      - name: Run NPM Audit (JSON Report)
        id: npm-audit
        working-directory: ./${{ matrix.workspace }}
        continue-on-error: true
        run: |
          npm audit --json > npm-audit-report.json 2>&1 || true
          if [ ! -s npm-audit-report.json ]; then
            echo '{"metadata":{"vulnerabilities":{"critical":0,"high":0,"moderate":0}}}' > npm-audit-report.json
          fi

      - name: Parse Audit Results
        id: parse-audit
        working-directory: ./${{ matrix.workspace }}
        run: |
          # Ensure valid JSON before parsing
          if ! jq empty npm-audit-report.json 2>/dev/null; then
            echo "Invalid JSON in audit report, creating empty report"
            echo '{"metadata":{"vulnerabilities":{"critical":0,"high":0,"moderate":0}}}' > npm-audit-report.json
          fi

          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-report.json 2>/dev/null || echo 0)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-report.json 2>/dev/null || echo 0)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit-report.json 2>/dev/null || echo 0)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT

          echo "## ðŸ”’ Security Audit - ${{ matrix.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  High: $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¡ Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY

      - name: Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-${{ matrix.workspace }}
          path: ./${{ matrix.workspace }}/npm-audit-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Fail on Critical Vulnerabilities
        if: steps.parse-audit.outputs.critical != '0' && steps.parse-audit.outputs.critical != ''
        run: |
          echo "âŒ CRITICAL VULNERABILITIES DETECTED: ${{ steps.parse-audit.outputs.critical }}"
          echo "Blocking deployment. Please fix critical vulnerabilities before merging."
          exit 1

      - name: Warn on High Vulnerabilities
        if: steps.parse-audit.outputs.high != '0' && steps.parse-audit.outputs.high != ''
        run: |
          echo "âš ï¸  HIGH VULNERABILITIES DETECTED: ${{ steps.parse-audit.outputs.high }}"
          echo "Please review and fix high-severity vulnerabilities."

  # ==========================================
  # 2. SOLIDITY SECURITY - Slither Analysis
  # ==========================================
  solidity-security:
    name: Solidity Smart Contract Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Check for Contracts
        id: check-contracts
        run: |
          if [ -d "./contracts" ] && [ "$(find ./contracts -name '*.sol' | head -1)" ]; then
            echo "has_contracts=true" >> $GITHUB_OUTPUT
          else
            echo "has_contracts=false" >> $GITHUB_OUTPUT
            echo "## ðŸ” Slither Security Analysis" >> $GITHUB_STEP_SUMMARY
            echo "No Solidity contracts found. Skipping analysis." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Node.js for Hardhat
        if: steps.check-contracts.outputs.has_contracts == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Hardhat Dependencies
        if: steps.check-contracts.outputs.has_contracts == 'true'
        run: npm ci

      - name: Setup Python
        if: steps.check-contracts.outputs.has_contracts == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Slither
        if: steps.check-contracts.outputs.has_contracts == 'true'
        run: |
          pip install slither-analyzer solc-select
          solc-select install 0.8.24
          solc-select use 0.8.24

      - name: Compile Contracts
        if: steps.check-contracts.outputs.has_contracts == 'true'
        run: npx hardhat compile
        continue-on-error: true

      - name: Run Slither Analysis
        if: steps.check-contracts.outputs.has_contracts == 'true'
        id: slither
        continue-on-error: true
        run: |
          # Run Slither with Hardhat output
          slither . --compile-force-framework hardhat --json slither-report.json \
            --exclude-dependencies \
            --exclude-informational \
            --exclude-low \
            --filter-paths "node_modules|test|mocks" \
            2>&1 || true

          # Create empty report if none exists
          if [ ! -f "slither-report.json" ]; then
            echo '{"success":true,"results":{"detectors":[]}}' > slither-report.json
          fi

          # Parse results safely
          if jq empty slither-report.json 2>/dev/null; then
            HIGH=$(jq '[.results.detectors[]? | select(.impact == "High")] | length' slither-report.json 2>/dev/null || echo 0)
            MEDIUM=$(jq '[.results.detectors[]? | select(.impact == "Medium")] | length' slither-report.json 2>/dev/null || echo 0)
          else
            HIGH=0
            MEDIUM=0
          fi

          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT

          echo "## ðŸ” Slither Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ High Impact: $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  Medium Impact: $MEDIUM" >> $GITHUB_STEP_SUMMARY

      - name: Upload Slither Report
        if: steps.check-contracts.outputs.has_contracts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: slither-security-report
          path: slither-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Fail on High-Impact Issues
        if: steps.slither.outputs.high != '0' && steps.slither.outputs.high != ''
        run: |
          echo "âŒ HIGH-IMPACT VULNERABILITIES IN SMART CONTRACTS: ${{ steps.slither.outputs.high }}"
          exit 1

  # ==========================================
  # 3. DEPENDENCY UPDATE CHECK
  # ==========================================
  dependency-update-check:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check Frontend Dependencies
        working-directory: ./frontend
        continue-on-error: true
        run: |
          npm outdated --json > frontend-outdated.json 2>/dev/null || echo '{}' > frontend-outdated.json
          echo "## ðŸ“¦ Frontend Outdated Packages" >> $GITHUB_STEP_SUMMARY
          if [ -s frontend-outdated.json ] && jq empty frontend-outdated.json 2>/dev/null; then
            jq -r 'to_entries[]? | "- \(.key): \(.value.current // "?") â†’ \(.value.latest // "?")"' frontend-outdated.json >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Backend Dependencies
        working-directory: ./backend
        continue-on-error: true
        run: |
          npm outdated --json > backend-outdated.json 2>/dev/null || echo '{}' > backend-outdated.json
          echo "## ðŸ“¦ Backend Outdated Packages" >> $GITHUB_STEP_SUMMARY
          if [ -s backend-outdated.json ] && jq empty backend-outdated.json 2>/dev/null; then
            jq -r 'to_entries[]? | "- \(.key): \(.value.current // "?") â†’ \(.value.latest // "?")"' backend-outdated.json >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Outdated Reports
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: |
            ./frontend/frontend-outdated.json
            ./backend/backend-outdated.json
          retention-days: 7
          if-no-files-found: ignore

  # ==========================================
  # 4. CUSTOM SECURITY MONITOR
  # ==========================================
  security-monitor:
    name: CVE & Security Advisory Monitor
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Script Dependencies
        uses: actions/cache@v4
        with:
          path: scripts/node_modules
          key: scripts-deps-${{ hashFiles('scripts/package-lock.json') }}
          restore-keys: scripts-deps-

      - name: Install Script Dependencies
        working-directory: scripts
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Security Monitor Script
        id: security-monitor
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_SECURITY_WEBHOOK }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_SECURITY_CHAT_ID }}
        working-directory: scripts
        run: |
          # Create fallback report if script fails
          node securityMonitor.js || {
            echo '{"status":"error","message":"Security monitor script failed","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > security-report.json
          }

          # Ensure report exists
          if [ ! -f "security-report.json" ]; then
            echo '{"status":"success","advisories":[],"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > security-report.json
          fi

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-advisory-report
          path: scripts/security-report.json
          retention-days: 30
          if-no-files-found: ignore

  # ==========================================
  # 5. CODE QUALITY & SECURITY LINTING
  # ==========================================
  eslint-security:
    name: ESLint Security Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install ESLint Security Plugins
        working-directory: ./frontend
        run: npm install --no-save eslint-plugin-security eslint-plugin-no-unsanitized

      - name: Run ESLint Security Scan
        working-directory: ./frontend
        continue-on-error: true
        run: |
          npx eslint src --ext .js,.jsx \
            --plugin security --plugin no-unsanitized \
            --format json --output-file eslint-security.json 2>&1 || true

          # Ensure valid JSON output
          if [ ! -f "eslint-security.json" ] || ! jq empty eslint-security.json 2>/dev/null; then
            echo '[]' > eslint-security.json
          fi

      - name: Upload ESLint Report
        uses: actions/upload-artifact@v4
        with:
          name: eslint-security-report
          path: ./frontend/eslint-security.json
          retention-days: 30
          if-no-files-found: ignore

  # ==========================================
  # 6. CODEQL ANALYSIS (GitHub Advanced Security)
  # ==========================================
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-and-quality
          # Exclude node_modules and build artifacts
          config: |
            paths-ignore:
              - node_modules
              - '**/node_modules'
              - frontend/dist
              - backend/dist

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"

  # ==========================================
  # 7. CREATE SECURITY REPORT ISSUE
  # ==========================================
  create-security-report:
    name: Generate Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        npm-security-audit,
        solidity-security,
        dependency-update-check,
        security-monitor,
        eslint-security,
        codeql-analysis,
      ]
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: ./security-reports

      - name: Generate Security Report
        run: |
          echo "# ðŸ”’ Security Audit Report - $(date +'%Y-%m-%d')" > SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "## Summary" >> SECURITY_REPORT.md
          echo "Automated security scan completed. Review artifacts for details." >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "### Artifacts Generated:" >> SECURITY_REPORT.md
          if [ -d "security-reports" ]; then
            ls -R security-reports/ >> SECURITY_REPORT.md 2>/dev/null || echo "No artifacts found" >> SECURITY_REPORT.md
          else
            echo "No security reports directory found" >> SECURITY_REPORT.md
          fi

      - name: Create Issue on Critical Vulnerabilities
        if: ${{ needs.npm-security-audit.result == 'failure' || needs.solidity-security.result == 'failure' }}
        uses: actions/github-script@v7
        with:
          script: |
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,automated',
              state: 'open'
            });

            // Don't create duplicate issues
            if (existingIssues.data.length === 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Security Vulnerabilities Detected - ' + new Date().toISOString().split('T')[0],
                body: `## Security Audit Failed\n\nCritical vulnerabilities detected in latest scan.\n\n**Run ID:** ${context.runId}\n**Workflow:** ${context.workflow}\n**Branch:** ${context.ref}\n\n**Action Required:** Review security reports and fix vulnerabilities before deployment.\n\n[View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['security', 'critical', 'automated']
              });
            }
